# Sort Machine TCG - MIMIR Platform

Sistema de detecção e classificação de cartas TCG para Raspberry Pi 5

## Hardware

### Raspberry Pi 5

- **Placa:** Raspberry Pi 5
- **Memória:** 8GB RAM
- **Armazenamento:** 32GB SD Card
- **OS:** Debian GNU/Linux (Kernel 6.12.47+rpt-rpi-2712)

### Câmeras CSI

O Raspberry Pi 5 possui duas portas CSI (CAM0 e CAM1), ambas em uso neste projeto.

#### Câmera 0 - IMX219 (8MP) — Picamera2 index `0`

- **Modelo:** SCHV 8MP Camera Module (clone IMX219)
- **Sensor:** Sony IMX219 (10-bit RGGB)
- **Resolução máxima:** 3280x2464 pixels (8.08 MP)
- **Foco:** Fixo (ajuste manual girando a lente)
- **Porta:** CAM1 (conector esquerdo)
- **Driver:** libcamera v0.6.0 + libpisp v1.3.0
- **Tuning file:** `/usr/share/libcamera/ipa/rpi/pisp/imx219.json`
- **Rotação:** 180°

| Resolução   | FPS    | Formato        | Uso recomendado              |
|-------------|--------|----------------|------------------------------|
| 3280x2464   | 21 fps | SRGGB10_CSI2P  | Máxima qualidade, fotos      |
| 1920x1080   | 47 fps | SRGGB10_CSI2P  | Full HD, vídeo               |
| 1640x1232   | 41 fps | SRGGB10_CSI2P  | Preview, processamento       |
| 640x480     | 103 fps| SRGGB10_CSI2P  | Alta velocidade, detecção    |

#### Câmera 1 - OV5647 (5MP) — Picamera2 index `1`

- **Modelo:** Raspberry Pi Camera Rev 1.3
- **Sensor:** OmnVision OV5647 (10-bit RGGB)
- **Resolução máxima:** 2592x1944 pixels (5.04 MP)
- **Foco:** Fixo
- **Porta:** CAM0 (conector direito) — usa adaptador de cabo flat
- **Driver:** libcamera v0.6.0 + libpisp v1.3.0
- **Tuning file:** `/usr/share/libcamera/ipa/rpi/pisp/ov5647.json`
- **Rotação:** 0°

| Resolução   | FPS    | Formato        | Uso recomendado              |
|-------------|--------|----------------|------------------------------|
| 2592x1944   | 15 fps | SGBRG10_CSI2P  | Máxima qualidade, fotos      |
| 1920x1080   | 30 fps | SGBRG10_CSI2P  | Full HD, vídeo               |
| 1296x972    | 42 fps | SGBRG10_CSI2P  | Preview, processamento       |
| 640x480     | 60 fps | SGBRG10_CSI2P  | Alta velocidade, detecção    |

#### Uso no código (Picamera2)

```python
from picamera2 import Picamera2

# Câmera IMX219 (8MP)
picam_imx219 = Picamera2(0)

# Câmera OV5647 (5MP - Rev 1.3)
picam_ov5647 = Picamera2(1)

# Listar todas as câmeras detectadas
print(Picamera2.global_camera_info())
```

#### Configuração no config.txt

```bash
# /boot/firmware/config.txt
camera_auto_detect=0
dtoverlay=imx219,cam0
dtoverlay=ov5647,cam1
```

**Nota:** A `camera_auto_detect=0` desabilita a detecção automática. Cada câmera
precisa de seu próprio `dtoverlay` com o sensor e a porta corretos.

#### Comandos úteis

```bash
# Listar câmeras detectadas
python3 -c "from picamera2 import Picamera2; print(Picamera2.global_camera_info())"

# Listar dispositivos V4L2
v4l2-ctl --list-devices

# Preview câmera 0 (5 segundos)
rpicam-hello --camera 0 -t 5000

# Preview câmera 1 (5 segundos)
rpicam-hello --camera 1 -t 5000

# Capturar foto câmera 0 (resolução máxima)
rpicam-still --camera 0 --zsl -o foto_cam0.jpg

# Capturar foto câmera 1 (resolução máxima)
rpicam-still --camera 1 --zsl -o foto_cam1.jpg

# Gravar vídeo
rpicam-vid -t 10000 --width 1920 --height 1080 -o video.h264
```

#### Parâmetros de exposição típicos (IMX219)

- **Exposição:** ~33ms (33251 µs)
- **Analog Gain:** 8.0
- **Digital Gain:** 1.0-1.02

## Instalação

### No Mac (Desenvolvimento)
```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### Na Raspberry Pi 5

```bash
sudo apt update
sudo apt install python3-pip python3-venv python3-picamera2 -y
sudo apt install libatlas-base-dev libhdf5-dev -y

python3 -m venv venv --system-site-packages
source venv/bin/activate
pip install -r requirements.txt
```

**Nota:** O flag `--system-site-packages` é necessário para acessar o Picamera2 instalado pelo sistema.

## Uso

### Detector Web com Camera CSI (Recomendado para Pi 5)

```bash
# Rodar detector web v3 (suporte a camera CSI IMX219)
python src/web_detector_onnx_v3.py
```

Acesse `http://<ip-raspberry>:5000` no navegador.

**Funcionalidades do v3:**

- Suporte nativo a camera CSI via Picamera2
- Fallback automatico para webcam USB
- Controles de exposicao, ganho e nitidez na interface web
- Captura em resolucao maxima (3280x2464)
- Stream em 640x480 para deteccao rapida

### Versões anteriores

```bash
# Detector web v2 (webcam USB apenas)
python src/web_detector_onnx_v2.py

# Detector web v1
python src/web_detector.py

# Testar câmera
python src/test_camera.py
```

## Configuração

Edite `config.json` para ajustar:
- Resolução da câmera
- Parâmetros de detecção
- Performance (frame skip, resize)

## Performance

Raspberry Pi 5 (8GB) esperado:
- 640x480: ~25-30 FPS
- 1280x720: ~15-20 FPS
- 1920x1080: ~8-12 FPS
